<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
</head>

<body style="background-color:black; padding:0; margin:0;">
    <div style="width:100%; text-align:center;">
        <button id="pickDirectory" type="button">Choose Directory</button>
        <img id="displayImage" src="" />
    </div>


<script type="text/javascript">
    'use strict';

    var ipc = require('electron').ipcRenderer;
    var nativeImage = require('electron').nativeImage;
    var fs = require('fs');
    var lwip = require('lwip');
    var path = require('path');

    var pickDirectoryButton = document.querySelector('#pickDirectory');
    var displayImage = document.querySelector('#displayImage');

    pickDirectoryButton.addEventListener("click", function() {
        ipc.send('OpenDirectoryDialog');
    });
    
    ipc.on("DirectorySelected", function(event, directory) {
        pickDirectoryButton.style.display = 'none';
        
        fs.readdir(directory, function(err, files) {
            console.log(files);

            var imageCounter = 0;
            var nrImages = files.length;

            var timer = setInterval(function() {

                var fileName = files[imageCounter];
                var fileExtension = path.extname(fileName);
                
                console.log(fileExtension);
                
                if(fileExtension != '.jpg' && fileExtension != '.png'
                   && fileExtension != '.gif' ) {
                    console.log('Unknown file type, returning');
                    imageCounter++;
                    return;
                }
                    
                var fullFilePath = directory + '/' + files[imageCounter]

                console.log(fileName);

                lwip.open(fullFilePath, function(err, image) {

                    if (err) {
                        console.log(err);
                        return;
                    }
                    
                    var windowWidth = window.innerWidth;
                    var windowHeight = window.innerHeight;

                    image.contain(windowWidth, windowHeight, "black", function(err, containedImage) {
                        containedImage.toBuffer("png", function(err, buffer) {
                            var nativeImageThing = nativeImage.createFromBuffer(buffer);
                            var data = nativeImageThing.toDataURL();
                            displayImage.src = data;

                        });
                    });

                    imageCounter++;

                    if (imageCounter == nrImages) {
                        clearInterval(timer);
                    }
                });

            }, 5000);
        });
    });
    
    
</script>
</body>
</html>
